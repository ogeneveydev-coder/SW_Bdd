<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Monster Search</title>

  <!--
    FICHIER : index.html
    VERSION : 1.8
    NOUVEAUTÉS v1.8 :
      - Icônes des ÉLÉMENTS : chargées depuis le dossier local "icons/".
      - ARCHÉTYPES : affichés en texte ("Archétype : ..."), plus d’icône.
      - Suppression des tooltips.
  -->

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#000000">

  <style>
    body { font-family: system-ui, sans-serif; margin: 2rem; color: #222; }
    .version { font-size: 0.9rem; color: #666; text-align: right; margin-bottom: 0.5rem; }
    .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; }
    .search-block { position: relative; }
    .search-block input { width: 100%; padding: 0.5rem; margin-top: 0.25rem; border: 1px solid #ccc; border-radius: 6px; }
    .search-block button { margin-top: 0.5rem; padding: 0.55rem 0.9rem; border-radius: 6px; border: none; background: #2b8; color: #fff; cursor: pointer; width: 100%; }
    .suggestions { border: 1px solid #ddd; background: #fff; position: absolute; top: 60px; left: 0; right: 0; z-index: 1000; box-shadow: 0 6px 18px rgba(0,0,0,0.06); border-radius: 6px; overflow: hidden; }
    .suggestions div { padding: 0.45rem 0.6rem; cursor: pointer; font-size: 0.95rem; color: #222; }
    .suggestions div:hover, .suggestions .active { background: #f4f7fb; }
    .results { margin-top: 1rem; }
    .card { border: 1px solid #e2e8f0; padding: 0.9rem; border-radius: 10px; background: #fff; text-align: center; box-shadow: 0 2px 6px rgba(20,20,20,0.03); }
    .card img.monster { border-radius: 8px; border: 1px solid #ddd; width: 80px; height: 80px; object-fit: contain; margin-bottom: 0.5rem; }
    .icon { width: 24px; height: 24px; vertical-align: middle; margin: 0 5px; }
    .stat { margin: 0.18rem 0; font-size: 0.95rem; }
    .small { color: #666; font-size: 0.85rem; }
    @media (max-width:900px){ .grid{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="version" id="versionLabel">Version</div>
  <h1>Monster Search</h1>
  <p class="lead">Comparez jusqu’à 3 monstres en parallèle</p>

  <div class="grid">
    <div class="search-block" id="search1">
      <label for="monster1">Monstre 1</label>
      <input type="text" id="monster1" placeholder="Nom du monstre">
      <div class="suggestions"></div>
      <button>Rechercher</button>
      <div class="results"></div>
    </div>
    <div class="search-block" id="search2">
      <label for="monster2">Monstre 2</label>
      <input type="text" id="monster2" placeholder="Nom du monstre">
      <div class="suggestions"></div>
      <button>Rechercher</button>
      <div class="results"></div>
    </div>
    <div class="search-block" id="search3">
      <label for="monster3">Monstre 3</label>
      <input type="text" id="monster3" placeholder="Nom du monstre">
      <div class="suggestions"></div>
      <button>Rechercher</button>
      <div class="results"></div>
    </div>
  </div>

  <script>
    const APP_VERSION = "1.8";
    document.getElementById("versionLabel").textContent = `Version ${APP_VERSION}`;
    let monsters = [];
    const SUGGESTION_LIMIT = 5;

    async function loadMonsters() {
      try {
        const res = await fetch('monsters_sw.json');
        monsters = await res.json();
        console.log(`✅ Monster Search v${APP_VERSION} chargé avec ${monsters.length} monstres.`);
      } catch (err) {
        console.error('Erreur chargement monsters_sw.json :', err);
      }
    }

    function initSearchBlock(block) {
      const input = block.querySelector("input");
      const btn = block.querySelector("button");
      const suggestions = block.querySelector(".suggestions");
      const results = block.querySelector(".results");
      let activeIndex = -1;

      function clearSuggestions() { suggestions.innerHTML = ""; activeIndex = -1; }
      function updateSuggestions() {
        const q = input.value.trim().toLowerCase();
        clearSuggestions();
        if (!q) return;
        const matches = monsters.filter(m => m.name && m.name.toLowerCase().includes(q)).slice(0, SUGGESTION_LIMIT);
        matches.forEach((m, idx) => {
          const div = document.createElement("div");
          div.textContent = m.name;
          div.dataset.index = idx;
          div.addEventListener("click", () => { input.value = m.name; clearSuggestions(); search(); });
          suggestions.appendChild(div);
        });
      }
      function setActive(items) {
        items.forEach(el => el.classList.remove('active'));
        if (activeIndex >= 0 && items[activeIndex]) items[activeIndex].classList.add('active');
      }

      function search() {
        const q = input.value.trim().toLowerCase();
        results.innerHTML = "";
        if (!q) return;
        const found = monsters.filter(m => m.name && m.name.toLowerCase().includes(q));
        if (found.length === 0) { results.innerHTML = `<p>Aucun monstre trouvé</p>`; return; }
        const monster = found[0];

        const imgUrl = monster.image_filename ? `https://swarfarm.com/static/herders/images/monsters/${monster.image_filename}` : "";
        const elemIconUrl = monster.element ? `icons/${monster.element.toLowerCase()}.png` : "";

        const leaderId = (monster.leader_skill || "").toString().trim();
        let leaderHtml = "";
        if (leaderId) {
          leaderHtml = `<p class="stat"><svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="#777"/></svg> Leader ID: ${leaderId}</p>`;
        }

        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <img class="monster" src="${imgUrl}" alt="${monster.name}">
          <h3>${monster.name}</h3>
          <p class="stat">
            ${elemIconUrl ? `<img class="icon" src="${elemIconUrl}" alt="${monster.element}">` : ""}
            ${monster.element || "–"}
          </p>
          <p class="stat">Archétype : ${monster.archetype || "–"}</p>
          <p class="stat"><strong>Étoiles :</strong> ${monster.base_stars || "–"}</p>
          <p class="stat"><strong>HP :</strong> ${monster.max_lvl_hp || monster.base_hp || "–"}</p>
          <p class="stat"><strong>ATK :</strong> ${monster.max_lvl_attack || monster.base_attack || "–"}</p>
          <p class="stat"><strong>DEF :</strong> ${monster.max_lvl_defense || monster.base_defense || "–"}</p>
          <p class="stat"><strong>Vitesse :</strong> ${monster.speed || "–"}</p>
          ${leaderHtml}
        `;
        results.appendChild(card);
      }

      input.addEventListener("input", updateSuggestions);
      btn.addEventListener("click", () => { clearSuggestions(); search(); });
      input.addEventListener("keydown", (e) => {
        const items = suggestions.querySelectorAll("div");
        if (e.key === "ArrowDown") { e.preventDefault(); if (items.length > 0) { activeIndex = (activeIndex + 1) % items.length; setActive(items); } }
        else if (e.key === "ArrowUp") { e.preventDefault(); if (items.length > 0) { activeIndex = (activeIndex - 1 + items.length) % items.length; setActive(items); } }
        else if (e.key === "Enter") { e.preventDefault(); if (activeIndex >= 0 && items[activeIndex]) { input.value = items[activeIndex].textContent; clearSuggestions(); } search(); }
        else if (e.key === "Escape") { clearSuggestions(); }
      });
      document.addEventListener("click", (ev) => { if (!block.contains(ev.target)) clearSuggestions(); });
    }

    ["search1","search2","search3"].forEach(id => initSearchBlock(document.getElementById(id)));
    loadMonsters();
  </script>
</body>
</html>
