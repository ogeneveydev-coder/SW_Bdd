<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Monster Search</title>

  <!--
    FICHIER : index.html
    VERSION : 2.4
    NOUVEAUTÉS v2.4 :
      - Autocomplétion collée directement sous la zone de recherche (alignement parfait).
      - Suppression de la ligne "Archétype" affichée sous la carte.
  -->

  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="style.css">
  <meta name="theme-color" content="#000000">
</head>
<body>
  <div class="version" id="versionLabel">Version</div>
  <h1>Monster Search</h1>
  <p class="lead">Comparez jusqu’à 3 monstres en parallèle</p>

  <div class="grid">
    <div class="search-block" id="search1">
      <label for="monster1">Monstre 1</label>
      <input type="text" id="monster1" placeholder="Nom du monstre">
      <div class="suggestions"></div>
      <button>Rechercher</button>
      <div class="results"></div>
    </div>
    <div class="search-block" id="search2">
      <label for="monster2">Monstre 2</label>
      <input type="text" id="monster2" placeholder="Nom du monstre">
      <div class="suggestions"></div>
      <button>Rechercher</button>
      <div class="results"></div>
    </div>
    <div class="search-block" id="search3">
      <label for="monster3">Monstre 3</label>
      <input type="text" id="monster3" placeholder="Nom du monstre">
      <div class="suggestions"></div>
      <button>Rechercher</button>
      <div class="results"></div>
    </div>
  </div>

  <script>
    const APP_VERSION = "2.4";
    document.getElementById("versionLabel").textContent = `Version ${APP_VERSION}`;
    let monsters = [];
    const SUGGESTION_LIMIT = 5;
    const selectedMonsters = new Set();

    async function loadMonsters() {
      try {
        const res = await fetch('monsters_sw.json');
        monsters = await res.json();
        console.log(`✅ Monster Search v${APP_VERSION} chargé avec ${monsters.length} monstres.`);
      } catch (err) {
        console.error('Erreur chargement monsters_sw.json :', err);
      }
    }

    function initSearchBlock(block) {
      const input = block.querySelector("input");
      const btn = block.querySelector("button");
      const suggestions = block.querySelector(".suggestions");
      const results = block.querySelector(".results");
      let activeIndex = -1;

      function clearSuggestions() { suggestions.innerHTML = ""; activeIndex = -1; }
      function updateSuggestions() {
        const q = input.value.trim().toLowerCase();
        clearSuggestions();
        if (!q) return;
        const matches = monsters
          .filter(m => m.name && m.name.toLowerCase().includes(q))
          .filter(m => !selectedMonsters.has(m.name))
          .slice(0, SUGGESTION_LIMIT);

        matches.forEach((m, idx) => {
          const div = document.createElement("div");
          div.textContent = m.name;
          div.dataset.index = idx;
          div.addEventListener("click", () => { input.value = m.name; clearSuggestions(); search(); });
          suggestions.appendChild(div);
        });
      }
      function setActive(items) {
        items.forEach(el => el.classList.remove('active'));
        if (activeIndex >= 0 && items[activeIndex]) items[activeIndex].classList.add('active');
      }

      function search() {
        const q = input.value.trim().toLowerCase();
        results.innerHTML = "";
        if (!q) return;
        const found = monsters.filter(m => m.name && m.name.toLowerCase() === q);
        if (found.length === 0) { results.innerHTML = `<p>Aucun monstre trouvé</p>`; return; }
        const monster = found[0];

        selectedMonsters.add(monster.name);

        const imgUrl = monster.image_filename ? `https://swarfarm.com/static/herders/images/monsters/${monster.image_filename}` : "";
        const elemIconUrl = monster.element ? `icons/${monster.element.toLowerCase()}.png` : "";

        const card = document.createElement('div');
        card.className = 'card fade-in';
        card.innerHTML = `
          <img class="monster" src="${imgUrl}" alt="${monster.name}">
          <h3>${monster.name}</h3>
          <p>
            ${elemIconUrl ? `<img class="icon" src="${elemIconUrl}" alt="${monster.element}">` : ""}
            <span class="small">${monster.element || "–"}</span>
          </p>
          <div class="stat-grid">
            <div><strong>Étoiles :</strong> ${monster.base_stars || "–"}</div>
            <div><strong>HP :</strong> ${monster.max_lvl_hp || monster.base_hp || "–"}</div>
            <div><strong>ATK :</strong> ${monster.max_lvl_attack || monster.base_attack || "–"}</div>
            <div><strong>DEF :</strong> ${monster.max_lvl_defense || monster.base_defense || "–"}</div>
            <div><strong>Vitesse :</strong> ${monster.speed || "–"}</div>
          </div>
        `;
        results.appendChild(card);
      }

      input.addEventListener("input", updateSuggestions);
      btn.addEventListener("click", () => { clearSuggestions(); search(); });
      input.addEventListener("keydown", (e) => {
        const items = suggestions.querySelectorAll("div");
        if (e.key === "ArrowDown") { e.preventDefault(); if (items.length > 0) { activeIndex = (activeIndex + 1) % items.length; setActive(items); } }
        else if (e.key === "ArrowUp") { e.preventDefault(); if (items.length > 0) { activeIndex = (activeIndex - 1 + items.length) % items.length; setActive(items); } }
        else if (e.key === "Enter") { e.preventDefault(); if (activeIndex >= 0 && items[activeIndex]) { input.value = items[activeIndex].textContent; clearSuggestions(); } search(); }
        else if (e.key === "Escape") { clearSuggestions(); }
      });
      document.addEventListener("click", (ev) => { if (!block.contains(ev.target)) clearSuggestions(); });
    }

    ["search1","search2","search3"].forEach(id => initSearchBlock(document.getElementById(id)));
    loadMonsters();
  </script>
</body>
</html>
